<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast - FloodResponse</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .weather-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .weather-icon img {
            width: 80px;
            height: 80px;
        }

        .temp-large {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
        }

        .rain-indicator {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
        }

        .location-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <i class="fas fa-water"></i>
                    FloodResponse
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="forecast.html" class="active">Forecasts</a></li>
                    <li><a href="alerts.html">Alerts</a></li>
                    <li><a href="shelters.html">Shelters</a></li>
                    <li><a href="helpline.html">Helpline</a></li>
                    <li><a href="report.html" class="btn btn-primary">Report Emergency</a></li>
                </ul>
                <div class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </div>
            </nav>
        </div>
    </header>

    <div class="container mt-4">
        <div class="text-center mb-4">
            <h1>Weather Forecast</h1>
            <p class="text-muted">3-Day rainfall and weather predictions for your location</p>
        </div>

        <!-- Location Info -->
        <div class="location-header text-center">
            <h2 id="location-name" style="margin-bottom: 10px;">
                <i class="fas fa-spinner fa-spin"></i> Loading weather data...
            </h2>
            <p id="current-date" style="font-size: 1.1rem; opacity: 0.9;"></p>
        </div>

        <!-- Current Weather -->
        <div id="current-weather" class="mb-4">
            <div class="text-center py-5">
                <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                <p class="mt-3">Loading current weather...</p>
            </div>
        </div>

        <!-- 3-Day Forecast -->
        <div class="filters mb-4">
            <h3><i class="fas fa-calendar-week"></i> 3-Day Forecast</h3>
        </div>

        <div class="card-grid" id="forecast-container"
            style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div class="text-center py-5" style="grid-column: 1 / -1;">
                <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                <p class="mt-3">Loading forecast...</p>
            </div>
        </div>

        <!-- Database Forecasts -->
        <div class="mt-5">
            <div class="filters mb-4">
                <h3><i class="fas fa-database"></i> Regional Flood Risk Data</h3>
                <button class="filter-btn active">All Regions</button>
                <button class="filter-btn">Punjab</button>
                <button class="filter-btn">Sindh</button>
                <button class="filter-btn">KPK</button>
                <button class="filter-btn">Balochistan</button>
            </div>

            <div class="card-grid" id="db-forecasts-container">
                <!-- Database forecasts will load here -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="copyright">
                <p>&copy; 2025 Flood Forecasting & Response System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../../js/utils.js"></script>
    <script src="../../js/api.js"></script>
    <script>
        const WEATHER_API_KEY = '5523bf8add464255b93210055252911';
        const WEATHER_API_BASE = 'https://api.weatherapi.com/v1';
        let userLocation = 'Lahore';

        function getUserLocation() {
            if (navigator.geolocation) {
                const timeout = setTimeout(() => {
                    fetchWeatherData(userLocation);
                }, 3000);

                navigator.geolocation.getCurrentPosition(
                    position => {
                        clearTimeout(timeout);
                        fetchWeatherData(`${position.coords.latitude},${position.coords.longitude}`);
                    },
                    error => {
                        clearTimeout(timeout);
                        fetchWeatherData(userLocation);
                    },
                    { timeout: 3000, enableHighAccuracy: false }
                );
            } else {
                fetchWeatherData(userLocation);
            }
        }

        async function fetchWeatherData(location) {
            try {
                const response = await fetch(
                    `${WEATHER_API_BASE}/forecast.json?key=${WEATHER_API_KEY}&q=${location}&days=3&aqi=no&alerts=no`
                );
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                displayCurrentWeather(data);
                displayForecast(data);
            } catch (error) {
                console.error('Error fetching weather:', error);
                document.getElementById('location-name').innerHTML =
                    `<i class="fas fa-exclamation-triangle"></i> Unable to load weather`;
                document.getElementById('current-weather').innerHTML = `
                    <div class="card" style="border-left: 4px solid #e74c3c;">
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                            <h4>Weather Service Unavailable</h4>
                            <p class="text-muted">Unable to fetch weather data.</p>
                            <button onclick="location.reload()" class="btn btn-primary mt-3">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function displayCurrentWeather(data) {
            const location = data.location;
            const current = data.current;

            document.getElementById('location-name').innerHTML =
                `<i class="fas fa-map-marker-alt"></i> ${location.name}, ${location.country}`;
            document.getElementById('current-date').textContent =
                new Date(location.localtime).toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });

            document.getElementById('current-weather').innerHTML = `
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="text-center">
                        <h3 style="color: white; margin-bottom: 20px;">Current Weather</h3>
                        <img src="https:${current.condition.icon}" alt="${current.condition.text}" style="width: 100px; height: 100px;">
                        <div class="temp-large" style="color: white;">${Math.round(current.temp_c)}째C</div>
                        <p style="font-size: 1.2rem; margin: 10px 0;">${current.condition.text}</p>
                        <div style="display: flex; justify-content: center; gap: 30px; margin-top: 20px; flex-wrap: wrap;">
                            <div><i class="fas fa-tint"></i> Humidity<br><strong style="font-size: 1.3rem;">${current.humidity}%</strong></div>
                            <div><i class="fas fa-wind"></i> Wind<br><strong style="font-size: 1.3rem;">${Math.round(current.wind_kph)} km/h</strong></div>
                            <div><i class="fas fa-cloud-rain"></i> Rain<br><strong style="font-size: 1.3rem;">${current.precip_mm} mm</strong></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayForecast(data) {
            const container = document.getElementById('forecast-container');
            container.innerHTML = data.forecast.forecastday.map(day => {
                const date = new Date(day.date);
                const rainMm = day.day.totalprecip_mm;
                const rainChance = day.day.daily_chance_of_rain;

                return `
                    <div class="weather-card text-center">
                        <h4 style="color: #667eea; font-weight: 600;">${date.toLocaleDateString('en-US', { weekday: 'short' })}</h4>
                        <p class="text-muted" style="font-size: 0.9rem;">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
                        <img src="https:${day.day.condition.icon}" alt="${day.day.condition.text}" style="width: 80px; height: 80px; margin: 10px 0;">
                        <div class="temp-large">${Math.round(day.day.avgtemp_c)}째C</div>
                        <p style="color: #999; font-size: 0.9rem; margin: 5px 0;">${Math.round(day.day.mintemp_c)}째 / ${Math.round(day.day.maxtemp_c)}째</p>
                        <p style="color: #666; margin: 10px 0;">${day.day.condition.text}</p>
                        ${rainMm > 0 || rainChance > 30 ? `
                            <div class="rain-indicator">
                                <i class="fas fa-cloud-rain"></i> ${rainMm.toFixed(1)}mm<br><small>${rainChance}% chance</small>
                            </div>
                        ` : '<p style="color: #27ae60;"><i class="fas fa-sun"></i> No rain expected</p>'}
                    </div>
                `;
            }).join('');
        }

        // Database forecasts
        const filterBtns = document.querySelectorAll('.filter-btn');
        let allDbForecasts = [];

        async function fetchDbForecasts() {
            try {
                allDbForecasts = await api.getForecasts();
                renderDbForecasts(allDbForecasts);
            } catch (error) {
                console.error('Error fetching DB forecasts:', error);
                document.getElementById('db-forecasts-container').innerHTML = `
                    <div class="text-center py-3 text-muted" style="grid-column: 1 / -1;">
                        <p>No regional data available</p>
                    </div>
                `;
            }
        }

        function renderDbForecasts(forecasts) {
            const container = document.getElementById('db-forecasts-container');

            if (forecasts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3 text-muted" style="grid-column: 1 / -1;">
                        <p>No regional forecasts available</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = forecasts.map(forecast => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <h3>${forecast.region || 'Unknown Region'}</h3>
                        <span class="alert-badge ${getRiskBadgeClass(forecast.riskLevel)}">${forecast.riskLevel || 'Unknown'}</span>
                    </div>
                    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                        <div style="flex: 1; text-align: center; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <i class="fas fa-water text-primary" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                            <p class="text-muted" style="font-size: 0.8rem;">River Level</p>
                            <h4>${forecast.riverLevel || 'Unknown'}</h4>
                        </div>
                        <div style="flex: 1; text-align: center; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <i class="fas fa-cloud-rain text-info" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                            <p class="text-muted" style="font-size: 0.8rem;">Rainfall</p>
                            <h4>${forecast.rainfall || 0}mm</h4>
                        </div>
                    </div>
                    <p>${forecast.description || 'No additional information available.'}</p>
                </div>
            `).join('');
        }

        function getRiskBadgeClass(riskLevel) {
            switch (riskLevel) {
                case 'High Risk': return 'alert-critical';
                case 'Medium Risk': return 'alert-warning';
                case 'Low Risk': return 'alert-info';
                default: return 'alert-secondary';
            }
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const filter = btn.innerText;
                if (filter === 'All Regions') {
                    renderDbForecasts(allDbForecasts);
                } else {
                    const filtered = allDbForecasts.filter(f => f.region === filter);
                    renderDbForecasts(filtered);
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            getUserLocation();
            fetchDbForecasts();
        });
    </script>
</body>

</html>