<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Shelter - FloodResponse</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <i class="fas fa-water"></i>
                    FloodResponse
                </div>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/forecast">Forecasts</a></li>
                    <li><a href="/alerts">Alerts</a></li>
                    <li><a href="/shelters" class="active">Shelters</a></li>
                    <li><a href="/helpline">Helpline</a></li>
                    <li><a href="/report" class="btn btn-primary">Report Emergency</a></li>
                </ul>
                <div class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </div>
            </nav>
        </div>
    </header>

    <div class="container mt-4">
        <div class="text-center mb-4">
            <h1>Evacuation Shelter Finder</h1>
            <p class="text-muted">Locate safe shelters and evacuation points near you.</p>
        </div>

        <div class="search-bar" style="position: relative;">
            <input type="text" id="location-search" class="search-input" placeholder="Enter your location...">
            <div id="autocomplete-dropdown" style="display: none;"></div>
            <button class="btn btn-primary" id="locate-btn"><i class="fas fa-location-arrow"></i> Use My
                Location</button>
        </div>

        <style>
            #autocomplete-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-top: none;
                border-radius: 0 0 8px 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                margin-top: -1px;
            }

            .autocomplete-item {
                padding: 12px 16px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
                transition: background-color 0.2s;
            }

            .autocomplete-item:last-child {
                border-bottom: none;
            }

            .autocomplete-item:hover {
                background-color: #f8f9fa;
            }

            .autocomplete-item i {
                margin-right: 8px;
                color: var(--primary-color);
            }

            .search-bar {
                position: relative;
            }

            #location-search {
                width: 100%;
            }
        </style>

        <div id="map"></div>

        <div class="mt-5">
            <h2>Nearby Shelters List</h2>
            <div class="card-grid" id="shelters-list">
                <!-- Shelter cards will be populated here -->
                <div class="text-center" style="grid-column: 1/-1;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading shelters...</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="copyright">
                <p>&copy; 2025 Flood Forecasting & Response System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/map.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize map centered on Lahore for demo
            const map = mapUtils.initMap('map', 31.5204, 74.3587, 12);
            const sheltersList = document.getElementById('shelters-list');
            const searchInput = document.getElementById('location-search');
            const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
            let debounceTimer;
            let allShelters = []; // Store all shelters globally

            // Function to calculate distance between two coordinates (Haversine formula)
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius of the Earth in kilometers
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distance = R * c; // Distance in kilometers
                return distance;
            }

            // Function to render shelters list
            function renderShelters(shelters, userLat = null, userLng = null) {
                sheltersList.innerHTML = '';

                // Calculate distances if user location is provided
                if (userLat !== null && userLng !== null) {
                    shelters = shelters.map(shelter => ({
                        ...shelter,
                        distance: calculateDistance(userLat, userLng, shelter.latitude, shelter.longitude)
                    }));

                    // Sort by distance (nearest first)
                    shelters.sort((a, b) => a.distance - b.distance);
                }

                shelters.forEach(shelter => {
                    const card = document.createElement('div');
                    card.className = 'card';

                    let distanceInfo = '';
                    if (shelter.distance !== undefined) {
                        distanceInfo = `<p class="text-muted"><i class="fas fa-route"></i> Distance: ${shelter.distance.toFixed(2)} km</p>`;
                    }

                    card.innerHTML = `
                        <h3><i class="fas fa-campground text-primary"></i> ${shelter.name}</h3>
                        <p class="text-muted"><i class="fas fa-map-marker-alt"></i> ${shelter.address}</p>
                        ${distanceInfo}
                        <div class="mt-2">
                            <span class="alert-badge alert-info">Capacity: ${shelter.capacity}</span>
                            <span class="alert-badge alert-warning">Occupied: ${shelter.currentOccupancy}</span>
                        </div>
                        <p class="mt-2"><strong>Facilities:</strong> ${shelter.facilities || 'N/A'}</p>
                        <p><strong>Contact:</strong> ${shelter.contactNumber}</p>
                        <button class="btn btn-outline mt-2" 
                            onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${shelter.latitude},${shelter.longitude}')"
                            style="color: var(--primary-color); border-color: var(--primary-color);">Get Directions</button>
                    `;
                    sheltersList.appendChild(card);
                });
            }

            try {
                // Fetch shelters from API
                allShelters = await api.getShelters();

                // Clear loading state/static content
                sheltersList.innerHTML = '';

                allShelters.forEach(shelter => {
                    // Add marker to map
                    mapUtils.addMarker(
                        shelter.latitude,
                        shelter.longitude,
                        `<b>${shelter.name}</b><br>Capacity: ${shelter.capacity}<br>Contact: ${shelter.contactNumber}`
                    );
                });

                // Render shelters initially (without sorting)
                renderShelters(allShelters);

            } catch (error) {
                console.error('Error loading shelters:', error);
                utils.showToast('Failed to load shelters', 'error');
                sheltersList.innerHTML = '<p class="text-center">Failed to load shelter data.</p>';
            }

            // Handle location search input with autocomplete
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;

                // Clear previous timer
                clearTimeout(debounceTimer);

                if (query.length < 3) {
                    autocompleteDropdown.style.display = 'none';
                    return;
                }

                // Debounce API calls
                debounceTimer = setTimeout(async () => {
                    try {
                        const suggestions = await mapUtils.getSuggestions(query);

                        if (suggestions.length > 0) {
                            autocompleteDropdown.innerHTML = suggestions.map(suggestion => `
                                <div class="autocomplete-item" data-lat="${suggestion.lat}" data-lng="${suggestion.lng}" data-name="${suggestion.name}">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${suggestion.name}
                                </div>
                            `).join('');
                            autocompleteDropdown.style.display = 'block';

                            // Add click handlers to suggestions
                            autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                                item.addEventListener('click', () => {
                                    const lat = parseFloat(item.dataset.lat);
                                    const lng = parseFloat(item.dataset.lng);
                                    const name = item.dataset.name;

                                    searchInput.value = name;
                                    autocompleteDropdown.style.display = 'none';

                                    // Update map
                                    map.setView([lat, lng], 13);
                                    L.marker([lat, lng]).addTo(map)
                                        .bindPopup(`<b>${name}</b>`).openPopup();

                                    // Re-render shelters sorted by distance
                                    renderShelters(allShelters, lat, lng);

                                    utils.showToast('Location found! Shelters sorted by distance.', 'success');
                                });
                            });
                        } else {
                            autocompleteDropdown.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error fetching suggestions:', error);
                        autocompleteDropdown.style.display = 'none';
                    }
                }, 300); // 300ms debounce
            });

            // Handle Enter key press
            searchInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = searchInput.value.trim();

                    if (!query) {
                        utils.showToast('Please enter a location', 'error');
                        return;
                    }

                    autocompleteDropdown.style.display = 'none';

                    try {
                        const location = await mapUtils.searchLocation(query);
                        utils.showToast('Location found! Shelters sorted by distance.', 'success');
                        searchInput.value = location.name;

                        // Re-render shelters sorted by distance
                        renderShelters(allShelters, location.lat, location.lng);
                    } catch (error) {
                        utils.showToast(error.message, 'error');
                    }
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                    autocompleteDropdown.style.display = 'none';
                }
            });

            // Handle "Use My Location" button
            document.getElementById('locate-btn').addEventListener('click', () => {
                mapUtils.locateUser()
                    .then(coords => {
                        utils.showToast('Location found! Shelters sorted by distance.', 'success');
                        searchInput.value = 'Your current location';

                        // Re-render shelters sorted by distance
                        renderShelters(allShelters, coords.lat, coords.lng);
                    })
                    .catch(err => {
                        utils.showToast(err, 'error');
                    });
            });
        });
    </script>
</body>

</html>
