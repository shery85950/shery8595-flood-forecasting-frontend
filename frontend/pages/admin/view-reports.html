<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Reports - FloodResponse Admin</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/admin.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-water"></i> Admin</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="/dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="/manage-alerts"><i class="fas fa-bell"></i> <span>Alerts</span></a></li>
                <li><a href="/manage-shelters"><i class="fas fa-home"></i> <span>Shelters</span></a></li>
                <li><a href="/manage-helplines"><i class="fas fa-phone"></i> <span>Helplines</span></a></li>
                <li><a href="/view-reports" class="active"><i class="fas fa-file-alt"></i> <span>Reports</span></a></li>
                <li><a href="/"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="admin-header">
                <h2>Emergency Reports</h2>
                <div class="filters">
                    <button class="filter-btn active" data-status="all">All Reports</button>
                    <button class="filter-btn" data-status="Pending">Pending</button>
                    <button class="filter-btn" data-status="In Progress">In Progress</button>
                    <button class="filter-btn" data-status="Resolved">Resolved</button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Reporter</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reports-table">
                        <!-- Reports will be loaded here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- View Report Modal -->
    <div id="viewReportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-modal" onclick="closeModal('viewReportModal')">&times;</span>
            <h2>Report Details</h2>
            <div id="reportDetails" class="mt-3">
                <!-- Report details will be loaded here -->
            </div>
            <div class="mt-3">
                <label><strong>Update Status:</strong></label>
                <select id="statusSelect" class="form-control mt-1">
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Resolved">Resolved</option>
                </select>
                <button class="btn btn-primary mt-2" onclick="updateReportStatus()">Update Status</button>
            </div>
        </div>
    </div>

    <script src="../../js/utils.js"></script>
    <script src="../../js/api.js"></script>
    <script>
        let allReports = [];
        let currentReportId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchReports();
            setupFilters();
        });

        // Fetch Reports
        async function fetchReports() {
            try {
                allReports = await api.getReports();
                renderReports(allReports);
            } catch (error) {
                console.error('Error fetching reports:', error);
                utils.showToast('Failed to load reports', 'error');
            }
        }

        // Render Reports Table
        function renderReports(reports) {
            const tbody = document.getElementById('reports-table');

            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No reports found</td></tr>';
                return;
            }

            tbody.innerHTML = reports.map(report => `
                <tr>
                    <td>#${report.id}</td>
                    <td>${report.reporterName}</td>
                    <td>${report.emergencyType}</td>
                    <td>${report.location}</td>
                    <td>${formatDate(report.reportedAt)}</td>
                    <td><span class="alert-badge ${getStatusClass(report.status)}">${report.status}</span></td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewReport(${report.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteReport(${report.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // View Report Details
        function viewReport(id) {
            const report = allReports.find(r => r.id === id);
            if (!report) return;

            currentReportId = id;

            const detailsHtml = `
                <div class="report-details">
                    <div class="detail-row">
                        <strong>Report ID:</strong> #${report.id}
                    </div>
                    <div class="detail-row">
                        <strong>Reporter Name:</strong> ${report.reporterName}
                    </div>
                    <div class="detail-row">
                        <strong>Contact:</strong> ${report.contactNumber}
                    </div>
                    <div class="detail-row">
                        <strong>Emergency Type:</strong> ${report.emergencyType}
                    </div>
                    <div class="detail-row">
                        <strong>Location:</strong> ${report.location}
                    </div>
                    <div class="detail-row">
                        <strong>Description:</strong> ${report.description}
                    </div>
                    <div class="detail-row">
                        <strong>Reported At:</strong> ${formatDateTime(report.reportedAt)}
                    </div>
                    <div class="detail-row">
                        <strong>Status:</strong> <span class="alert-badge ${getStatusClass(report.status)}">${report.status}</span>
                    </div>
                </div>
            `;

            document.getElementById('reportDetails').innerHTML = detailsHtml;
            document.getElementById('statusSelect').value = report.status;
            openModal('viewReportModal');
        }

        // Update Report Status
        async function updateReportStatus() {
            if (!currentReportId) return;

            const newStatus = document.getElementById('statusSelect').value;

            try {
                await api.updateReportStatus(currentReportId, newStatus);
                utils.showToast('Report status updated', 'success');
                closeModal('viewReportModal');
                fetchReports();
            } catch (error) {
                console.error('Error updating status:', error);
                utils.showToast('Failed to update status', 'error');
            }
        }

        // Delete Report
        async function deleteReport(id) {
            if (!confirm('Are you sure you want to delete this report?')) return;

            try {
                await api.deleteReport(id);
                utils.showToast('Report deleted', 'success');
                fetchReports();
            } catch (error) {
                console.error('Error deleting report:', error);
                utils.showToast('Failed to delete report', 'error');
            }
        }

        // Setup Filters
        function setupFilters() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const status = btn.dataset.status;
                    if (status === 'all') {
                        renderReports(allReports);
                    } else {
                        const filtered = allReports.filter(r => r.status === status);
                        renderReports(filtered);
                    }
                });
            });
        }

        // Helper Functions
        function getStatusClass(status) {
            const classes = {
                'Pending': 'alert-warning',
                'In Progress': 'alert-info',
                'Resolved': 'alert-success'
            };
            return classes[status] || 'alert-secondary';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Modal Functions
        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            currentReportId = null;
        }

        window.onclick = function (event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }
    </script>

    <style>
        .report-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .detail-row {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row strong {
            display: inline-block;
            min-width: 150px;
            color: #555;
        }
    </style>
</body>

</html>
